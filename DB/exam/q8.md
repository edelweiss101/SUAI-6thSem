# 8. Структура и создание документных баз данных на примере MongoDB

[◀️ К списку вопросов](README.md)

## Содержание

- [Назначение документных баз данных](#назначение-документных-баз-данных)
- [Принципы проектирования документных баз данных](#принципы-проектирования-документных-баз-данных)
- [Построение логической модели по концептуальной](#построение-логической-модели-по-концептуальной)
- [Первичные ключи в MongoDB](#первичные-ключи-в-mongodb)
- [Особенности реализации внешних ключей в MongoDB](#особенности-реализации-внешних-ключей-в-mongodb)
  - [Ручные ссылки (Manual References)](#ручные-ссылки-manual-references)
  - [Вложенные документы (Embedded Documents)](#вложенные-документы-embedded-documents)
  - [DBRef](#dbref)
  - [Обеспечение целостности](#обеспечение-целостности)
- [Синтаксис и пример создания базы данных в MongoDB](#синтаксис-и-пример-создания-базы-данных-в-mongodb)
- [Дополнительные аспекты проектирования](#дополнительные-аспекты-проектирования)

Документные базы данных относятся к классу нереляционных (NoSQL) систем управления базами данных, где данные хранятся в виде документов, обычно в формате BSON (Binary JSON), представляющем собой бинарное расширение JSON. MongoDB является одной из наиболее популярных документно-ориентированных СУБД, отличающейся гибкостью, масштабируемостью и поддержкой сложных структур данных. В отличие от реляционных баз данных, документные базы не требуют жёсткой схемы, что позволяет хранить данные с динамически изменяющейся структурой.

## Назначение документных баз данных

Документные СУБД предназначены для следующих задач:

- Хранение и обработка структурированных и полуструктурированных данных, таких как профили пользователей, каталоги товаров или контент веб-приложений.
- Поддержка приложений с высокой скоростью разработки, где структура данных может меняться в процессе эксплуатации.
- Обеспечение горизонтального масштабирования для высоконагруженных систем, таких как веб-приложения, системы управления контентом (CMS) или платформы электронной коммерции.
- Работа с данными, содержащими вложенные структуры, массивы и динамически добавляемые поля.
- Реализация микросервисной архитектуры и интеграция с REST API благодаря естественной совместимости с JSON-подобными форматами.

MongoDB широко применяется в веб-приложениях, системах управления контентом, платформах для аналитики в реальном времени, мобильных приложениях и других сценариях, где важны гибкость и производительность.

> [Наверх ⬆️](#содержание)

## Принципы проектирования документных баз данных

Проектирование документной базы данных начинается с анализа требований предметной области и построения концептуальной модели, которая затем преобразуется в логическую модель, учитывающую особенности документного подхода. Основные принципы проектирования включают:

- **Денормализация данных**: В отличие от реляционных баз, где данные нормализуются для устранения избыточности, в документных базах предпочтительно встраивать связанные данные в один документ. Это минимизирует количество запросов и упрощает чтение данных.
- **Встраивание (embedding)**: Связанные данные включаются непосредственно в родительский документ. Например, информация об адресе пользователя может быть вложена в документ профиля, а не храниться в отдельной коллекции.
- **Ссылки (referencing)**: Для связей типа «многие ко многим» или при работе с большими объёмами данных используются ссылки на другие документы, обычно через поле `_id`. Это требует дополнительных запросов для получения связанных данных, но снижает избыточность.
- **Гибкость схемы**: Документы в одной коллекции могут иметь различную структуру, что позволяет добавлять или изменять поля без необходимости модификации всей базы данных.
- **Оптимизация под запросы**: Структура документов проектируется с учётом наиболее частых операций чтения и записи, чтобы минимизировать количество запросов и повысить производительность.

При проектировании важно учитывать баланс между встраиванием и ссылками, а также прогнозировать будущие изменения в структуре данных.

> [Наверх ⬆️](#содержание)

## Построение логической модели по концептуальной

[Методические указания к выполнению лабораторных работ](methodical_instructions_for_labs.pdf#page=6) (стр. 6).

> [Наверх ⬆️](#содержание)

## Первичные ключи в MongoDB

Каждый документ в MongoDB обязан содержать уникальное поле `_id`, которое выполняет роль первичного ключа в коллекции. Основные характеристики первичных ключей в MongoDB:

- **Автоматическая генерация идентификатора**: Если поле `_id` не указано при вставке документа, MongoDB автоматически генерирует значение типа `ObjectId`. `ObjectId` — это 12-байтовый уникальный идентификатор, состоящий из:
  - 4 байта — метка времени создания (timestamp), обеспечивающая хронологический порядок;
  - 5 байт — комбинация идентификатора машины, процесса и случайного значения, гарантирующая уникальность между узлами;
  - 3 байта — инкрементный счётчик для различения документов, созданных в одной и той же секунде на одном узле.
  Пример документа с автоматически сгенерированным `_id`:

  ```json
  {
    "_id": ObjectId("665bf876b8fcb0e1e1c0a1a1"),
    "name": "Alice",
    "email": "alice@example.com"
  }
  ```

- **Индексация**: Поле `_id` автоматически индексируется как уникальный индекс при создании коллекции. Это обеспечивает высокую производительность операций поиска и обновления по `_id`. Индекс создаётся автоматически и не требует дополнительной настройки.

- **Ограничения**: Поле `_id` является неизменяемым после создания документа. Для изменения `_id` необходимо удалить документ и создать новый с новым значением `_id`. Кроме того, значение `_id` не может быть массивом, чтобы избежать сложностей с индексацией.

- **Использование в шардинге**: Шардинг - горизонтальное масштабирование баз данных, при котором данные разделяются на части (шарды) и распределяются по разным серверам. Каждый шард содержит подмножество данных, что позволяет повысить производительность и управлять большими объёмами информации. В MongoDB поле `_id` часто используется как ключ шардирования в распределённых системах MongoDB, поскольку его уникальность и предсказуемая структура способствуют равномерному распределению данных между шардами.

> [Наверх ⬆️](#содержание)

## Особенности реализации внешних ключей в MongoDB

MongoDB, как нереляционная база данных, не поддерживает внешние ключи на уровне СУБД, как это реализовано в реляционных системах. Вместо этого связи между данными реализуются на уровне приложения с использованием логических ссылок, вложенных документов или специального формата DBRef. Целостность связей также обеспечивается приложением, хотя с версии MongoDB 4.0 появилась поддержка транзакций для согласованных операций с несколькими документами.

### Ручные ссылки (Manual References)

Наиболее распространённый способ реализации связей, при котором документ хранит значение `_id` другого документа из другой коллекции. Например:

```json
{
  "_id": ObjectId("665bf876b8fcb0e1e1c0a1a2"),
  "title": "MongoDB Guide",
  "author_id": ObjectId("665bf876b8fcb0e1e1c0a1a1")
}
```

Для получения данных об авторе требуется выполнить дополнительный запрос:

```javascript
db.authors.findOne({ "_id": ObjectId("665bf876b8fcb0e1e1c0a1a1") });
```

Этот подход требует от приложения логики для проверки существования и актуальности ссылок, что увеличивает сложность кода, но обеспечивает гибкость и минимизирует избыточностданных.

### Вложенные документы (Embedded Documents)

Если связанные данные тесно связаны и часто запрашиваются вместе, их можно встроить в родительский документ. Например:

```json
{
  "_id": ObjectId("665bf876b8fcb0e1e1c0a1a2"),
  "title": "MongoDB Guide",
  "author": {
    "name": "Alice",
    "email": "alice@example.com",
    "country": "USA"
  }
}
```

Встраивание упрощает запросы, так как все данные находятся в одном документе, но может привести к увеличению размера документа (лимит в MongoDB — 16 МБ) и усложнить обновлениевложенных данных, если они используются в нескольких документах.

### DBRef

MongoDB поддерживает специальный формат DBRef для стандартизации ссылок между документами. DBRef — это объект, содержащий три поля:

- `$ref`: имя коллекции, на которую указывает ссылка;
- `$id`: значение `_id` целевого документа;
- `$db` (опционально): имя базы данных, если она отличается от текущей.

Пример DBRef:

```javascript
db.books.insertOne({
    "_id": ObjectId("665bf876b8fcb0e1e1c0a1a2"),
    "title": "MongoDB Guide",
    "author": {
        "$ref": "authors",
        "$id": ObjectId("665bf876b8fcb0e1e1c0a1a1"),
        "$db": "library"
    }
})
```

**Почему не рекомендуется использовать DBRef**:

- **Отсутствие встроенной поддержки**: MongoDB не предоставляет автоматических механизмов для обработки DBRef, таких как проверка целостности или автоматическое извлечение данных, что делает их не более функциональными, чем ручные ссылки.
- **Дополнительные накладные расходы**: Хранение метаданных (`$ref`, `$db`) увеличивает размер документа, что может быть критично при больших объёмах данных, учитывая лимит в 16 МБ на документ.
- **Сложность обработки**: Работа с DBRef требует дополнительных запросов, аналогичных ручным ссылкам, но усложняет код из-за необходимости обработки структуры DBRef. Например, для получения данных об авторе из DBRef нужно сначала извлечь поля `$ref` и `$id`, а затем выполнить запрос к указанной коллекции:

  ```javascript
  const book = db.books.findOne({ "_id": ObjectId("665bf876b8fcb0e1e1c0a1a2") });
  const author = db[book.author.$ref].findOne({ "_id": book.author.$id });
  ```

  Это добавляет дополнительный уровень сложности по сравнению с ручными ссылками, где достаточно одного запроса по `_id`:

  ```javascript
  const book = db.books.findOne({ "_id": ObjectId("665bf876b8fcb0e1e1c0a1a2") });
  const author = db.authors.findOne({ "_id": book.author_id });
  ```

- **Ограниченная поддержка драйверами**: Не все драйверы MongoDB поддерживают автоматическое разрешение DBRef, что снижает их универсальность.
- **Есть лучшие альтернативы**: Ручные ссылки проще в реализации, так как требуют только хранения `_id` и позволяют приложению гибко управлять связями. Для сложных операций можно использовать агрегацию с `$lookup` или транзакции, что делает DBRef избыточным.

### Обеспечение целостности

Поскольку MongoDB не проверяет целостность ссылок, приложение должно:

- Проверять существование целевого документа перед добавлением ссылки.
- Обрабатывать случаи, когда связанные документы удалены или изменены.
- Использовать транзакции для согласованного обновления связанных данных. Например:

```javascript
const session = db.getMongo().startSession();
session.startTransaction();
try {
  db.users.updateOne(
    { "_id": "user1" },
    { $set: { "status": "active" } },
    { session }
  );
  db.orders.updateOne(
    { "user_id": "user1" },
    { $set: { "status": "processed" } },
    { session }
  );
  session.commitTransaction();
} catch (error) {
  session.abortTransaction();
  throw error;
} finally {
  session.endSession();
}
```

Транзакции гарантируют атомарность операций, но их использование увеличивает накладные расходы, поэтому они применяются только при необходимости строгой согласованности.

> [Наверх ⬆️](#содержание)

## Синтаксис и пример создания базы данных в MongoDB

В MongoDB база данных и коллекции создаются автоматически при первом использовании, что упрощает процесс инициализации. Для работы с MongoDB используется Mongo Shell или драйверы для различных языков программирования.

**Пример создания базы данных и коллекции в Mongo Shell**:

1. Переключение на базу данных (если база не существует, она создаётся при первой вставке данных):

    ```javascript
    use library
    ```

2. Создание коллекции (необязательно, так как коллекция создаётся автоматически при вставке первого документа):

    ```javascript
    db.createCollection("books")
    ```

3. Вставка документа в коллекцию:

    ```javascript
    db.books.insertOne({
        "_id": ObjectId("665bf876b8fcb0e1e1c0a1a2"),
        "title": "Data Modeling in NoSQL",
        "author": {
            "name": "John Smith",
            "email": "john@example.com",
            "country": "USA"
        },
        "tags": ["database", "nosql", "design"],
        "published": ISODate("2023-05-15"),
        "available": true,
        "price": 29.99
    })
    ```

> [Наверх ⬆️](#содержание)

## Дополнительные аспекты проектирования

- **Индексация**: Для ускорения запросов MongoDB поддерживает создание индексов на поля документов, включая вложенные поля и массивы. Например:

```javascript
db.books.createIndex({ "title": 1 });
db.books.createIndex({ "author.name": 1 });
```

- **Шардинг**: MongoDB поддерживает горизонтальное масштабирование через шардинг, разделяя данные между несколькими серверами. Ключ шардирования выбирается на основе поля, обеспечивающего равномерное распределение данных (например, `_id` или пользовательский ключ).
- **Репликация**: Для обеспечения высокой доступности и отказоустойчивости MongoDB использует наборы реплик (replica sets), где данные синхронизируются между первичным и вторичными узлами.
- **Ограничения размера документа**: Максимальный размер документа в MongoDB составляет 16 МБ, что требует продуманного подхода к встраиванию данных, чтобы избежать превышения лимита.

MongoDB предоставляет мощные инструменты для работы с динамическими данными, позволяя разработчикам быстро адаптировать структуру базы под изменяющиеся требования приложения. Гибкость в сочетании с поддержкой сложных запросов, транзакций и масштабирования делает MongoDB универсальным решением для современных приложений.

> [Наверх ⬆️](#содержание)
