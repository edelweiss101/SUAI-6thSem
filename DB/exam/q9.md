
# 9. Манипуляции данными в документных базах данных на примере MongoDB

## Содержание

- [Вставка данных](#вставка-данных)
- [Изменение данных](#изменение-данных)
- [Удаление данных](#удаление-данных)

В MongoDB операции манипулирования данными включают вставку, обновление и удаление документов в коллекциях. Эти операции выполняются с использованием методов MongoDB API, доступных через Mongo Shell, драйверы для различных языков программирования или графические интерфейсы. MongoDB поддерживает гибкую работу с данными благодаря отсутствию жёсткой схемы, что позволяет легко добавлять, изменять или удалять поля в документах. Все операции манипулирования данными ориентированы на атомарность на уровне одного документа, хотя с версии 4.0 поддерживаются транзакции для согласованных изменений в нескольких документах.

## Вставка данных

Операции вставки позволяют добавлять новые документы в коллекцию. MongoDB автоматически создаёт коллекцию, если она ещё не существует, при первой вставке данных. Вставка может быть выполнена для одного или нескольких документов.

**Вставка одного документа** (`insertOne`):

**Синтаксис**:

```javascript
db.collection.insertOne(
   <document>,
   { writeConcern: <document> }
)
```

- `<document>`: Объект, представляющий вставляемый документ. Если поле `_id` не указано, MongoDB автоматически генерирует уникальный `ObjectId`.
- `writeConcern`: Опциональный объект, определяющий уровень подтверждения записи (например, `{ w: "majority" }`).

**Пример**:

```javascript
db.users.insertOne({
  "_id": "user1",
  "name": "Alice",
  "age": 30,
  "email": "alice@example.com",
  "address": {
    "street": "123 Main St",
    "city": "New York"
  }
});
```

**Результат**:

```json
{
  "acknowledged": true,
  "insertedId": "user1"
}
```

**Вставка нескольких документов** (`insertMany`):

**Синтаксис**:

```javascript
db.collection.insertMany(
   [<document1>, <document2>, ...],
   {
      writeConcern: <document>,
      ordered: <boolean>
   }
)
```

- `[<document1>, <document2>, ...]`: Массив объектов, представляющих вставляемые документы.
- `writeConcern`: Опциональный объект, определяющий уровень подтверждения записи.
- `ordered`: Опциональный булевый параметр (по умолчанию `true`). Если `true`, документы вставляются в порядке очереди; если `false`, вставка выполняется без строгого порядка, что может повысить производительность.

**Пример**:

```javascript
db.users.insertMany([
  {
    "_id": "user2",
    "name": "Bob",
    "age": 25,
    "email": "bob@example.com"
  },
  {
    "_id": "user3",
    "name": "Carol",
    "age": 28,
    "email": "carol@example.com"
  }
]);
```

**Результат**:

```json
{
  "acknowledged": true,
  "insertedIds": {
    "0": "user2",
    "1": "user3"
  }
}
```

**Особенности вставки**:

- Если коллекция не существует, она создаётся автоматически.
- Поле `_id` должно быть уникальным в пределах коллекции; попытка вставить документ с уже существующим `_id` вызовет ошибку.
- Вставка поддерживает вложенные структуры (объекты и массивы) без необходимости предварительного определения схемы.

> [Наверх ⬆️](#содержание)

## Изменение данных

Операции обновления позволяют изменять существующие документы в коллекции. MongoDB поддерживает как частичное обновление отдельных полей, так и полную замену документа. Обновления выполняются с использованием операторов, которые определяют, как именно изменять данные.

**Обновление одного документа** (`updateOne`):

**Синтаксис**:

```javascript
db.collection.updateOne(
   <filter>,
   <update>,
   {
      upsert: <boolean>,
      writeConcern: <document>,
      collation: <document>,
      arrayFilters: [<filterdoc1>, ...],
      hint: <document|string>
   }
)
```

- `<filter>`: Объект, определяющий критерии выбора документа для обновления.
- `<update>`: Объект с операторами обновления (например, `$set`, `$unset`, `$inc`).
- `upsert`: Если `true`, создаёт новый документ, если фильтр не находит совпадений (по умолчанию `false`).
- `writeConcern`: Опциональный объект, определяющий уровень подтверждения записи.
- `collation`: Опциональный объект для настройки правил сортировки и сравнения строк.
- `arrayFilters`: Массив фильтров для обновления элементов в массивах.
- `hint`: Указание индекса для выполнения запроса.

**Пример**:

```javascript
db.users.updateOne(
  { "name": "Alice" },
  {
    $set: { "age": 31, "status": "active" },
    $unset: { "email": "" }
  }
);
```

**Результат**:

```json
{
  "acknowledged": true,
  "matchedCount": 1,
  "modifiedCount": 1
}
```

**Обновление нескольких документов** (`updateMany`):

**Синтаксис**:

```javascript
db.collection.updateMany(
   <filter>,
   <update>,
   {
      upsert: <boolean>,
      writeConcern: <document>,
      collation: <document>,
      arrayFilters: [<filterdoc1>, ...],
      hint: <document|string>
   }
)
```

- Параметры аналогичны `updateOne`, но обновляются все документы, соответствующие фильтру.

**Пример**:

```javascript
db.users.updateMany(
  { "age": { $lt: 30 } },
  {
    $inc: { "age": 1 },
    $set: { "updated_at": ISODate("2025-06-02T17:00:00Z") }
  }
);
```

**Результат**:

```json
{
  "acknowledged": true,
  "matchedCount": 2,
  "modifiedCount": 2
}
```

**Полная замена документа** (`replaceOne`):

**Синтаксис**:

```javascript
db.collection.replaceOne(
   <filter>,
   <replacement>,
   {
      upsert: <boolean>,
      writeConcern: <document>,
      collation: <document>,
      hint: <document|string>
   }
)
```

- `<filter>`: Объект, определяющий критерии выбора документа.
- `<replacement>`: Новый документ, который полностью заменит существующий (поле `_id` сохраняется).
- Параметры `upsert`, `writeConcern`, `collation`, `hint` аналогичны `updateOne`.

**Пример**:

```javascript
db.users.replaceOne(
  { "name": "Bob" },
  {
    "_id": "user2",
    "name": "Bob",
    "age": 26,
    "city": "New York",
    "status": "active"
  }
);
```

**Результат**:

```json
{
  "acknowledged": true,
  "matchedCount": 1,
  "modifiedCount": 1
}
```

**Операторы обновления**:

- `$set`: Задаёт значение для поля (или создаёт новое поле, если оно отсутствует).
- `$unset`: Удаляет указанное поле.
- `$inc`: Увеличивает или уменьшает числовое значение поля.
- `$push`: Добавляет элемент в массив.
- `$pull`: Удаляет элемент из массива.
- `$addToSet`: Добавляет элемент в массив, только если его там ещё нет.
- `$rename`: Переименовывает поле.
- `$currentDate`: Устанавливает текущее время для поля.

**Пример работы с массивом**:

```javascript
db.users.updateOne(
  { "name": "Alice" },
  {
    $push: { "hobbies": "reading" },
    $addToSet: { "hobbies": "cycling" }
  }
);
```

**Особенности обновления**:

- Операции обновления атомарны на уровне одного документа.
- Для сложных обновлений (например, в массивах или вложенных документах) используются точечная нотация (`field.subfield`) или операторы для работы с массивами.
- Если фильтр не находит документов, можно использовать опцию `upsert: true` для создания нового документа:

```javascript
db.users.updateOne(
  { "name": "Dave" },
  { $set: { "age": 35 } },
  { upsert: true }
);
```

> [Наверх ⬆️](#содержание)

## Удаление данных

Операции удаления позволяют удалять документы из коллекции по заданному критерию. MongoDB предоставляет методы для удаления одного или нескольких документов, а также для очистки всей коллекции.

**Удаление одного документа** (`deleteOne`):

**Синтаксис**:

```javascript
db.collection.deleteOne(
   <filter>,
   {
      writeConcern: <document>,
      collation: <document>,
      hint: <document|string>
   }
)
```

- `<filter>`: Объект, определяющий критерии выбора документа для удаления.
- `writeConcern`: Опциональный объект, определяющий уровень подтверждения записи.
- `collation`: Опциональный объект для настройки правил сравнения строк.
- `hint`: Указание индекса для выполнения запроса.

**Пример**:

```javascript
db.users.deleteOne({ "name": "Carol" });
```

**Результат**:

```json
{
  "acknowledged": true,
  "deletedCount": 1
}
```

**Удаление нескольких документов** (`deleteMany`):

**Синтаксис**:

```javascript
db.collection.deleteMany(
   <filter>,
   {
      writeConcern: <document>,
      collation: <document>,
      hint: <document|string>
   }
)
```

- Параметры аналогичны `deleteOne`, но удаляются все документы, соответствующие фильтру.

**Пример**:

```javascript
db.users.deleteMany({ "age": { $gt: 40 } });
```

**Результат**:

```json
{
  "acknowledged": true,
  "deletedCount": 3
}
```

**Очистка коллекции**:

Для удаления всех документов в коллекции используется `deleteMany` с пустым фильтром:

**Синтаксис**:

```javascript
db.collection.deleteMany({})
```

**Пример**:

```javascript
db.users.deleteMany({});
```

**Результат**:

```json
{
  "acknowledged": true,
  "deletedCount": 5
}
```

Альтернативно, коллекцию можно удалить полностью с помощью `drop`:

**Синтаксис**:

```javascript
db.collection.drop(
   { writeConcern: <document> }
)
```

**Пример**:

```javascript
db.users.drop();
```

**Особенности удаления**:

- Удаление документов необратимо, поэтому рекомендуется использовать фильтры с осторожностью.
- Для удаления связанных данных в нескольких коллекциях можно использовать транзакции:

```javascript
const session = db.getMongo().startSession();
session.startTransaction();
try {
  db.users.deleteOne({ "_id": "user1" }, { session });
  db.orders.deleteMany({ "user_id": "user1" }, { session });
  session.commitTransaction();
} catch (error) {
  session.abortTransaction();
  throw error;
} finally {
  session.endSession();
}
```

**Работа с вложенными структурами**:
MongoDB поддерживает обновление и удаление данных во вложенных документах и массивах с использованием точечной нотации и операторов. Пример удаления элемента из массива:

```javascript
db.users.updateOne(
  { "name": "Alice" },
  { $pull: { "hobbies": "reading" } }
);
```

**Дополнительные аспекты**:

- **Транзакции**: Для обеспечения согласованности при манипуляциях с несколькими коллекциями рекомендуется использовать транзакции, особенно в сценариях, где важна целостность данных.
- **Производительность**: Операции с массивами и вложенными документами могут быть менее эффективными при больших объёмах данных, поэтому важно оптимизировать структуру документов и использовать индексы.
- **Индексация**: Для ускорения операций обновления и удаления необходимо создавать индексы на часто используемые поля фильтрации (например, `name` или `age`).

MongoDB предоставляет мощный и гибкий набор инструментов для манипулирования данными, позволяя эффективно работать с динамическими структурами и поддерживать высокую производительность в веб-приложениях и других системах.

> [Наверх ⬆️](#содержание)
