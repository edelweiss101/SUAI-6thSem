# 7. Базы данных «Ключ-значение» на примере Redis/Valkey

[◀️ К списку вопросов](README.md)

## Содержание

- [Случаи использования баз данных «Ключ-значение»](#случаи-использования-баз-данных-ключ-значение)
- [Примеры СУБД «Ключ-значение»](#примеры-субд-ключ-значение)
- [Типы данных Redis/Valkey](#типы-данных-redisvalkey)
- [Ключи в Redis/Valkey](#ключи-в-redisvalkey)
- [CRUD-операции в Redis/Valkey](#crud-операции-в-redisvalkey)
  - [Операции создания/обновления (Create/Update)](#операции-созданияобновления-createupdate)
  - [Операции чтения (Read)](#операции-чтения-read)
  - [Операции обновления (Update)](#операции-обновления-update)
  - [Операции удаления (Delete)](#операции-удаления-delete)
- [Ключи с ограниченным временем жизни в Redis/Valkey](#ключи-с-ограниченным-временем-жизни-в-redisvalkey)
- [Лицензирование и причины появления Valkey](#лицензирование-и-причины-появления-valkey)
- [Пример реализации хранения сложных структур в Redis/Valkey](#пример-реализации-хранения-сложных-структур-в-redisvalkey)
- [Практические рекомендации](#практические-рекомендации)

Базы данных типа «ключ-значение» (Key-Value Stores) представляют собой нереляционные СУБД, где данные хранятся в виде пар «ключ — значение». Эта простая структура обеспечивает высокую производительность и масштабируемость, делая такие базы идеальными для задач, требующих быстрого доступа к данным.

## Случаи использования баз данных «Ключ-значение»

СУБД «ключ-значение» применяются в следующих сценариях:

- **Кэширование**: Хранение результатов запросов, веб-страниц или вычислений для ускорения доступа.
- **Управление сессиями**: Сохранение данных пользовательских сессий в веб-приложениях.
- **Счётчики и метки времени**: Отслеживание событий, просмотров страниц или метрик в реальном времени.
- **Очереди сообщений**: Реализация асинхронных очередей для обработки задач.
- **Pub/Sub-механизмы**: Поддержка систем обмена сообщениями в реальном времени.
- **Хранение временных данных**: Использование ключей с TTL (временем жизни) для токенов или кэшей.

> [Наверх ⬆️](#содержание)

## Примеры СУБД «Ключ-значение»

- **Redis**: Высокопроизводительная in-memory база данных с поддержкой сложных типов данных и широким набором операций.
- **Valkey**: Форк Redis, созданный для сохранения открытой лицензии, совместимый с Redis по протоколу и API.
- **Memcached**: Простая in-memory система кэширования с минималистичным функционалом.
- **Riak KV**: Распределённая СУБД с высокой устойчивостью к сбоям.
- **Amazon DynamoDB**: Управляемая облачная база данных с поддержкой высокой масштабируемости.

> [Наверх ⬆️](#содержание)

## Типы данных Redis/Valkey

Redis и Valkey поддерживают не только простые строки, но и структурированные типы данных, что делает их более гибкими, чем классические key-value хранилища:

- **String**: Строки, числа или бинарные данные (до 512 МБ).
- **List**: Упорядоченные списки строк, поддерживающие операции добавления/удаления с начала и конца.
- **Set**: Неупорядоченные множества уникальных строк с операциями объединения, пересечения и разности.
- **Sorted Set**: Множества с числовыми приоритетами (score) для упорядочивания элементов.
- **Hash**: Ассоциативные массивы, хранящие пары «ключ-значение» внутри одного ключа.
- **Bitmap**: Битовые массивы для эффективной работы с битовыми операциями.
- **HyperLogLog**: Структура для приближённого подсчёта уникальных элементов с минимальным потреблением памяти.
- **Stream**: Потоки данных для обработки сообщений в реальном времени, поддерживающие очереди и группы потребителей.

> [Наверх ⬆️](#содержание)

## Ключи в Redis/Valkey

Ключи в Redis и Valkey — это строковые идентификаторы, уникально определяющие значение в базе данных. Они являются основой для доступа к данным, хранящимся в формате пар «ключ-значение».

- **Структура ключа**: Ключи обычно состоят из нескольких частей, разделённых символом-разделителем (чаще всего `:`). Например: `user:1001:profile` включает:
  - `user`: Пространство имён, обозначающее тип сущности.
  - `1001`: Уникальный идентификатор сущности (например, ID пользователя).
  - `profile`: Конкретное свойство или атрибут сущности.
- **Количество частей ключа**: Ключ может состоять из произвольного числа частей. На практике обычно используют от 2 до 5 частей для баланса между читаемостью и производительностью.
- **Соглашения об именовании**: Используйте единообразные разделители (например, `:`, `-`, `.`) и понятные имена для предотвращения конфликтов и повышения читаемости. Например, `session:token:abc123` ясно указывает на токен сессии.
- **Ограничения**: Ключи чувствительны к регистру, могут содержать любые печатные ASCII-символы, максимальная длина — 512 МБ (рекомендуются короткие ключи для производительности).
- **Рекомендации**: Избегайте пробелов, специальных символов и слишком длинных ключей для обеспечения совместимости и эффективности. Используйте иерархическую структуру для группировки связанных данных, но избегайте избыточной вложенности, чтобы упростить управление ключами.

> [Наверх ⬆️](#содержание)

## CRUD-операции в Redis/Valkey

Redis и Valkey поддерживают CRUD-операции (создание, чтение, обновление, удаление) для работы с данными различных типов (String, Hash, List, Set). Ниже приведены примеры ключевых операций с описанием их синтаксиса.

### Операции создания/обновления (Create/Update)

- `SET key value [EX seconds] [PX milliseconds]`: Устанавливает указанное значение для ключа. Если ключ существует, значение перезаписывается. Параметры `EX` или `PX` задают время жизни ключа в секундах или миллисекундах соответственно.

```bash
SET user:1001 "Alice"
```

- `HSET key field value [field value ...]`: Устанавливает одну или несколько пар «поле-значение» в хэше, хранящемся по указанному ключу. Перезаписывает существующие поля или создаёт новые, если они отсутствуют.

```bash
HSET user:1001:profile name "Alice" age "30" email "alice@example.com"
```

- `LPUSH key value [value ...]`: Добавляет одно или несколько значений в начало списка, хранящегося по указанному ключу. Создаёт список, если он не существует.

```bash
LPUSH recent:users "Alice" "Bob"
```

- `SADD key member [member ...]`: Добавляет один или несколько элементов в множество, хранящееся по указанному ключу. Дубликаты игнорируются, так как множества содержат только уникальные элементы. Создаёт множество, если оно не существует.

```bash
SADD user:1001:subscriptions "news" "sports"
```

### Операции чтения (Read)

- `GET key`: Возвращает значение, связанное с указанным ключом. Если ключ не существует, возвращается `nil`.

```bash
GET user:1001
```

- `HGETALL key`: Возвращает все поля и их значения из хэша, хранящегося по указанному ключу. Если хэш не существует, возвращается пустой список.

```bash
HGETALL user:1001:profile
```

- `LRANGE key start stop`: Возвращает элементы списка, хранящегося по указанному ключу, в диапазоне от индекса `start` до `stop`. Использование `0 -1` возвращает все элементы списка.

```bash
LRANGE recent:users 0 -1
```

- `SMEMBERS key`: Возвращает все элементы множества, хранящегося по указанному ключу. Если множество не существует, возвращается пустой список.

```bash
SMEMBERS user:1001:subscriptions
```

### Операции обновления (Update)

- `INCR key`: Увеличивает целочисленное значение ключа на 1. Если ключ не существует, он создаётся со значением 0 перед инкрементом. Значение должно быть целым числом.

```bash
INCR page:views
```

- `HSET key field value`: Обновляет значение указанного поля в хэше, хранящемся по ключу. Создаёт поле или хэш, если они отсутствуют.

```bash
HSET user:1001:profile age "31"
```

- `RPUSH key value [value ...]`: Добавляет одно или несколько значений в конец списка, хранящегося по указанному ключу. Создаёт список, если он не существует.

```bash
RPUSH recent:users "Carol"
```

### Операции удаления (Delete)

- `DEL key [key ...]`: Удаляет один или несколько указанных ключей и их значения. Игнорирует ключи, которые не существуют.

```bash
DEL user:1001
```

- `HDEL key field [field ...]`: Удаляет одно или несколько полей из хэша, хранящегося по указанному ключу. Игнорирует поля, которые не существуют.

```bash
HDEL user:1001:profile email
```

- `SREM key member [member ...]`: Удаляет один или несколько элементов из множества, хранящегося по указанному ключу. Игнорирует элементы, которые не существуют.

```bash
SREM user:1001:subscriptions "news"
```

> [Наверх ⬆️](#содержание)

## Ключи с ограниченным временем жизни в Redis/Valkey

Ключи с TTL (Time To Live) автоматически удаляются по истечении заданного времени, что делает их подходящими для хранения временных данных, таких как токены аутентификации, кэши или сессии.

**Синтаксис создания ключей с TTL:**

```bash
# Установка ключа с TTL в секундах
SET session:token "abc123" EX 3600

# Установка ключа с TTL в миллисекундах
SET page:cache "html-content" PX 5000

# Применение TTL к существующему ключу
EXPIRE user:1001 120

# Проверка оставшегося времени жизни
TTL session:token
```

**Особенности:**

- TTL задаётся в секундах (`EX`) или миллисекундах (`PX`).
- Команда `TTL` возвращает оставшееся время в секундах, а `PTTL` — в миллисекундах.
- Если TTL не задан, ключ существует бессрочно.
- Применение TTL полезно для экономии памяти и предотвращения накопления устаревших данных.

**Пример использования:**

```bash
SET auth:token:12345 "user:1001" EX 3600
TTL auth:token:12345  # Вернёт ~3600 секунд
```

> [Наверх ⬆️](#содержание)

## Лицензирование и причины появления Valkey

Redis изначально распространялся под лицензией BSD-3-Clause, что обеспечивало открытость и свободное использование. В 2024 году Redis Labs изменила лицензию на Redis Source Available License (RSAL), ограничивающую коммерческое использование и вызвавшую обеспокоенность в сообществе open-source.

**Valkey** был создан как форк Redis под эгидой Linux Foundation с сохранением открытой лицензии BSD-3-Clause. Основные причины появления Valkey:

- Сохранение открытости и доступности для всех пользователей и разработчиков.
- Обеспечение совместимости с протоколом и API Redis, что позволяет использовать существующие клиенты и инструменты.
- Независимое развитие с акцентом на сообщество и поддержку новых функций.
- Устранение ограничений RSAL, таких как запрет на использование в коммерческих облачных сервисах.

Valkey поддерживает те же типы данных и команды, что и Redis, и активно развивается для обеспечения стабильности и производительности.

> [Наверх ⬆️](#содержание)

## Пример реализации хранения сложных структур в Redis/Valkey

Для моделирования сложных данных, таких как профиль пользователя, можно комбинировать хэши, списки и множества:

```bash
# Хранение профиля пользователя
HSET user:1001 name "Alice" age "30" email "alice@example.com"

# Хранение подписок
SADD user:1001:subscriptions "news" "sports" "movies"

# Хранение истории активности
LPUSH user:1001:activity "login" "view_profile" "logout"
LTRIM user:1001:activity 0 9  # Ограничение списка до 10 элементов

# Хранение временного токена
SET auth:token:abc123 "user:1001" EX 3600
```

**Чтение данных:**

```bash
HGETALL user:1001
SMEMBERS user:1001:subscriptions
LRANGE user:1001:activity 0 -1
GET auth:token:abc123
```

**Особенности:**

- Хэши эффективны для хранения структурированных данных, таких как профили.
- Множества подходят для уникальных списков, например, подписок или тегов.
- Списки идеальны для хранения упорядоченных данных, таких как история действий.
- TTL позволяет управлять временными данными, минимизируя ручную очистку.

> [Наверх ⬆️](#содержание)

## Практические рекомендации

1. **Выбор типа данных**: Используйте подходящий тип данных (хэш, список, множество) в зависимости от структуры и операций с данными.
2. **Оптимизация памяти**: Применяйте TTL для временных данных и используйте `LTRIM` для ограничения списков.
3. **Ключевая структура**: Стандартизируйте формат ключей (например, `namespace:id:property`) для удобства управления.
4. **Обработка ошибок**: Проверяйте существование ключей с помощью `EXISTS` перед операциями чтения.
5. **Документирование**: Описывайте структуру ключей и типы данных в документации для упрощения поддержки.
6. **Мониторинг производительности**: Используйте команды `INFO` и `MONITOR` для анализа использования памяти и производительности.

> [Наверх ⬆️](#содержание)
