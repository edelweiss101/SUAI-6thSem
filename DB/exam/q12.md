# 12. Назначение, структура баз данных типа «Семейство столбцов». Операции CRUD в БД «Семейство столбцов» и администрирование таблиц на примере HBase

## Содержание

- [Случаи использования столбцовых БД](#случаи-использования-столбцовых-бд)
- [Примеры столбцовых СУБД](#примеры-столбцовых-субд)
- [Особенности структуры хранения данных в HBase](#особенности-структуры-хранения-данных-в-hbase)
- [Операции CRUD в HBase (через HBase Shell)](#операции-crud-в-hbase-через-hbase-shell)
  - [Создание таблицы](#создание-таблицы)
  - [Вставка данных (put)](#вставка-данных-put)
  - [Чтение данных (get, scan)](#чтение-данных-get-scan)
  - [Обновление данных](#обновление-данных)
  - [Удаление данных (delete, deleteall)](#удаление-данных-delete-deleteall)
- [Особенности удаления данных и таблиц](#особенности-удаления-данных-и-таблиц)
- [Администрирование таблиц в HBase](#администрирование-таблиц-в-hbase)

## Случаи использования столбцовых БД

Базы данных типа «Семейство столбцов» особенно эффективны в сценариях, где требуется быстрая обработка больших объёмов данных, поступающих из разных источников с высокой скоростью, а также выполнение аналитических запросов. Их архитектура, ориентированная на хранение данных по столбцам, обеспечивает оптимальную производительность для задач, связанных с агрегацией, фильтрацией и анализом. Основные области применения включают:

- **Хранение и анализ логов**: Обработка больших объёмов журналов событий, таких как системные логи серверов, логи веб-приложений, данные телеметрии IoT-устройств или записи активности пользователей. Например, HBase используется для хранения логов кликов на веб-сайтах, позволяя быстро анализировать поведение пользователей в реальном времени.
- **Временные ряды**: Управление последовательными данными, такими как метрики производительности (CPU, память), финансовые котировки, данные с датчиков или телеметрия IoT-устройств. Столбцовые БД эффективно справляются с высокоскоростной записью и чтением временных рядов, поддерживая сжатие и компактизацию данных.
- **Рекомендательные системы**: Хранение пользовательских профилей, истории просмотров или взаимодействий для построения персонализированных рекомендаций. Например, данные о покупках или просмотрах фильмов могут быть организованы в столбцы для быстрого анализа предпочтений.
- **Профили пользователей**: Управление большими наборами данных о пользователях в социальных сетях, платформах электронной коммерции или игровых системах. Столбцовые БД позволяют хранить разнообразные атрибуты (например, демографические данные, настройки, активности) с гибкой структурой.
- **Web-аналитика**: Анализ больших объёмов данных о поведении пользователей, таких как клики, просмотры страниц, время пребывания на сайте или конверсии. Столбцовые БД обеспечивают высокую производительность при выполнении агрегаций, таких как подсчёт просмотров по регионам или категориям.
- **Хранилища данных для аналитики**: Использование в системах бизнес-аналитики (BI) для хранения и обработки больших объёмов данных, необходимых для построения отчётов, дашбордов или прогнозов. Например, анализ продаж по регионам или временным периодам.
- **Обработка геопространственных данных**: Хранение и анализ данных с географической привязкой, таких как координаты, маршруты или данные с GPS-трекеров, где требуется быстрый доступ к атрибутам, связанным с местоположением.

Столбцовые базы данных, такие как HBase, особенно подходят для распределённых систем с высокими требованиями к масштабируемости и отказоустойчивости, обеспечивая низкую задержку при работе с большими объёмами данных.

> [Наверх ⬆️](#содержание)

## Примеры столбцовых СУБД

- **Apache HBase**: распределённая СУБД, работающая поверх Hadoop HDFS, обеспечивающая случайный доступ в реальном времени.
- **Apache Cassandra**: децентрализованная СУБД с высокой доступностью и отказоустойчивостью.
- **ScyllaDB**: высокопроизводительная СУБД, совместимая с Cassandra, но реализованная на C++ для минимизации задержек.
- **ClickHouse**: оптимизирована для аналитических запросов и обработки больших объёмов данных в реальном времени.

> [Наверх ⬆️](#содержание)

## Особенности структуры хранения данных в HBase

HBase использует модель хранения, основанную на концепции «семейств столбцов», которая существенно отличается от реляционных баз данных. Данные организованы в распределённой файловой системе HDFS, что обеспечивает горизонтальное масштабирование и высокую производительность при работе с большими объёмами информации. Основные элементы структуры:

- **Таблица**: Логический контейнер, объединяющий строки и семейства столбцов. Таблицы в HBase автоматически разбиваются на **регионы** (regions), которые распределяются по узлам кластера для обеспечения масштабируемости и балансировки нагрузки. Каждый регион содержит подмножество строк таблицы, определяемое диапазоном ключей строк.
- **Ключ строки (Row Key)**: Уникальный идентификатор строки, используемый для быстрого доступа к данным. Ключи сортируются лексикографически, что позволяет эффективно выполнять операции сканирования в заданных диапазонах. Дизайн ключа строки критически важен, так как он определяет производительность и равномерность распределения данных.
- **Семейство столбцов (Column Family)**: Группа столбцов, объединённых по логическому признаку (например, `profile` для личных данных или `activity` для событий). Семейства столбцов задаются при создании таблицы и являются статическими, а их параметры (например, сжатие, количество версий) влияют на производительность и хранение. Семейства физически хранятся отдельно, что оптимизирует доступ к данным.
- **Ключи столбцов (Column Qualifiers)**: Динамически задаваемые имена столбцов внутри семейства, позволяющие гибко добавлять атрибуты без изменения схемы таблицы. Например, в семействе `profile` могут быть столбцы `name`, `age`, `email`, добавляемые по мере необходимости.
- **Ячейки**: Элемент данных, определяемый комбинацией ключа строки, семейства столбцов, ключа столбца и временной метки. Ячейка содержит значение (например, строку, число или бинарные данные) и может хранить несколько версий, каждая из которых помечена уникальной временной меткой.
- **Версии**: HBase поддерживает версионность данных, позволяя хранить несколько значений для одной ячейки с разными временными метками. Количество версий задаётся параметром `VERSIONS` для каждого семейства столбцов (по умолчанию 3). Это полезно для отслеживания изменений данных, например, истории активности пользователя.
- **Временные метки**: Каждая ячейка автоматически получает временную метку, которая используется для идентификации версии данных. Временные метки позволяют выполнять операции с учётом времени, такие как получение последней версии или восстановление предыдущих.
- **Сжатие и компактизация**: HBase поддерживает сжатие данных (например, с использованием алгоритмов Snappy или GZIP) на уровне семейств столбцов, что уменьшает объём хранимых данных. Процесс компактизации (compaction) объединяет файлы данных и удаляет устаревшие версии или маркеры удаления, оптимизируя производительность и использование дискового пространства.

**Пример структуры таблицы в HBase**:

```text
Table: users
Row Key: user123
Column Family: profile
  Column Qualifiers: name, age, email
  Values: "Alice", "30", "alice@example.com"
  Timestamps: 1622559600000, 1622559600000, 1622559600000
Column Family: activity
  Column Qualifiers: login_time, last_action
  Values: "2025-06-01T10:00:00", "viewed_profile"
  Timestamps: 1622559601000, 1622559602000
```

HBase обеспечивает высокую производительность за счёт распределённого хранения и индексации по ключам строк, а также оптимизирует доступ к данным благодаря разделению на регионы и поддержке версионности. Однако проектирование ключей строк и семейств столбцов требует тщательного планирования, чтобы избежать «горячих точек» (hotspots) и обеспечить равномерное распределение данных по кластеру.

> [Наверх ⬆️](#содержание)

## Операции CRUD в HBase (через HBase Shell)

HBase предоставляет интерфейс для выполнения операций CRUD (Create, Read, Update, Delete) через HBase Shell, API (Java, Python и др.) или клиентские библиотеки. Ниже приведены примеры операций в HBase Shell с указанием синтаксиса функций.

### Создание таблицы

**Синтаксис**:

```shell
create 'table_name', {NAME => 'column_family_name', VERSIONS => n, [COMPRESSION => 'compression_type'], [TTL => seconds]}
```

**Пример**:

```shell
create 'users', {NAME => 'profile', VERSIONS => 3}, {NAME => 'activity', VERSIONS => 5}
```

Создаёт таблицу `users` с двумя семействами столбцов: `profile` (хранит до 3 версий данных) и `activity` (хранит до 5 версий). Параметр `VERSIONS` задаёт максимальное количество версий значений для ячеек.

### Вставка данных (put)

**Синтаксис**:

```shell
put 'table_name', 'row_key', 'column_family:column_qualifier', 'value', [timestamp]
```

**Пример**:

```shell
put 'users', 'user123', 'profile:name', 'Alice'
put 'users', 'user123', 'profile:age', '30'
put 'users', 'user123', 'profile:email', 'alice@example.com'
put 'users', 'user123', 'activity:login_time', '2025-06-01T10:00:00'
```

Добавляет данные в строку с ключом `user123`. Каждая команда `put` записывает значение в указанную ячейку, а временная метка добавляется автоматически (или может быть указана явно, например, `put 'users', 'user123', 'profile:age', '30', 1622559600000`).

### Чтение данных (get, scan)

**Синтаксис**:

```shell
get 'table_name', 'row_key', [COLUMNS => ['column_family:column_qualifier', ...], VERSIONS => n, TIMESTAMP => ts]
scan 'table_name', [COLUMNS => ['column_family:column_qualifier', ...], LIMIT => n, STARTROW => 'row_key', STOPROW => 'row_key']
```

**Пример**:

```shell
get 'users', 'user123'
```

Возвращает все данные для строки с ключом `user123`, включая все семейства столбцов и их значения.

```shell
get 'users', 'user123', {COLUMNS => 'profile:name'}
```

Возвращает только значение столбца `name` из семейства `profile`.

```shell
scan 'users', {COLUMNS => ['profile:name', 'profile:age'], LIMIT => 10, STARTROW => 'user100', STOPROW => 'user200'}
```

Сканирует таблицу, возвращая имена и возраст для первых 10 строк в диапазоне ключей строк от `user100` до `user200`. Операция `scan` поддерживает фильтры, ограничения по столбцам и диапазоны ключей строк.

### Обновление данных

**Синтаксис**:

```shell
put 'table_name', 'row_key', 'column_family:column_qualifier', 'new_value', [timestamp]
```

**Пример**:

```shell
put 'users', 'user123', 'profile:age', '31'
```

Обновляет возраст пользователя `user123` до 31. Старая версия значения сохраняется (в пределах лимита `VERSIONS`), что позволяет откатиться к предыдущим данным при необходимости.

### Удаление данных (delete, deleteall)

**Синтаксис**:

```shell
delete 'table_name', 'row_key', 'column_family:column_qualifier', [timestamp]
deleteall 'table_name', 'row_key'
```

**Пример**:

```shell
delete 'users', 'user123', 'profile:email'
```

Удаляет столбец `email` из семейства `profile` для строки `user123`.

```shell
deleteall 'users', 'user123'
```

Удаляет все данные, связанные с ключом строки `user123`, включая все семейства столбцов.

> [Наверх ⬆️](#содержание)

## Особенности удаления данных и таблиц

- **Маркеры удаления (tombstones)**: При выполнении операций `delete` или `deleteall` HBase не удаляет данные физически, а создаёт маркер удаления, который указывает, что данные более не актуальны. Фактическое удаление происходит во время процесса **major compaction** (основной сборки мусора), когда данные физически удаляются из хранилища.
- **Настройка сборки мусора**: Для оптимизации производительности и освобождения пространства необходимо настраивать параметры компактизации (compaction) и задавать разумное количество версий (`VERSIONS`) для семейств столбцов, чтобы избежать накопления устаревших данных.
- **Удаление таблицы**:

```shell
disable 'users'
drop 'users'
```

Перед удалением таблицы её необходимо отключить с помощью команды `disable`, чтобы предотвратить доступ к данным во время операции удаления. Команда `drop` удаляет таблицу и все связанные с ней данные из HDFS.

> [Наверх ⬆️](#содержание)

## Администрирование таблиц в HBase

Администрирование таблиц в HBase включает управление структурой, производительностью и масштабированием. Основные задачи администрирования:

- **Создание и настройка таблиц**:
  - При создании таблицы задаются семейства столбцов и их параметры, такие как `VERSIONS`, `COMPRESSION` (для сжатия данных), `TTL` (время жизни данных).
  - Пример с дополнительными параметрами:

```shell
create 'users', {NAME => 'profile', VERSIONS => 3, COMPRESSION => 'SNAPPY', TTL => 2592000}
```

Задаёт сжатие данных алгоритмом Snappy и автоматическое удаление данных старше 30 дней (2,592,000 секунд).

- **Разделение таблиц на регионы**:
  - HBase автоматически разбивает таблицы на регионы (regions) для распределения данных по узлам кластера. Администратор может управлять разбиением, задавая границы ключей строк (split points):

```shell
create 'users', 'profile', {SPLITS => ['user100', 'user200', 'user300']}
```

- **Мониторинг и оптимизация**:
  - Использование команды `status` для проверки состояния кластера:

```shell
status 'detailed'
```

- Настройка компактизации и сжатия для повышения производительности.
- Мониторинг загрузки регионов с помощью HBase Web UI или инструментов, таких как Apache Ambari.

- **Изменение структуры таблицы**:
  - Добавление нового семейства столбцов:

```shell
alter 'users', {NAME => 'settings', VERSIONS => 1}
```

- Изменение параметров существующего семейства:

```shell
alter 'users', {NAME => 'profile', VERSIONS => 5}
```

  Перед изменением структуры таблицу также необходимо отключить (`disable`).

- **Резервное копирование и восстановление**:
  - HBase поддерживает экспорт и импорт данных с помощью утилит, таких как `Export` и `Import`, или создание снимков (snapshots):

```shell
snapshot 'users', 'users_snapshot_20250602'
restore_snapshot 'users_snapshot_20250602'
```

> [Наверх ⬆️](#содержание)
